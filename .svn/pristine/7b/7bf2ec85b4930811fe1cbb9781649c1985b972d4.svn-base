package com.example.tingpan.grpproject;

import android.app.Service;
import android.content.Intent;
import android.content.res.AssetManager;
import android.os.AsyncTask;
import android.os.Binder;
import android.os.Environment;
import android.os.IBinder;
import android.util.Log;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;

/**
 * Created by TingPan on 2/12/15.
 */
public class GameFileStore extends Service{
    private AssetManager assetManager;
    private File rootDir;
    private static final String ROOT_DIR_NAME = "serverIt";
    private static final String TAG = "FileStore";
    private static final String EVENT_ACTION = "com.file.event";
    private static final String PROGRESS_ACTION = "com.node.progress";
    private MyBind myBind = new MyBind();
    private Intent broadcastIntent = new Intent();

    @Override
    public IBinder onBind(Intent intent) {
        return myBind;
    }

    @Override
    public void onCreate(){
        super.onCreate();
        Log.d(TAG,"File Service is init");
        assetManager = getAssets();
        rootDir = new File(Environment.getExternalStorageDirectory().getAbsolutePath(), ROOT_DIR_NAME);

    }

    @Override
    public int onStartCommand(Intent intent, int flags, int startId){
        Log.d(TAG,"File Service is start");
        if (!rootDir.exists()||!rootDir.isDirectory()){
            if (!rootDir.mkdir()){
                Log.e(TAG, "can not create folder here");
                sendMyBroadcast(PROGRESS_ACTION,"can not create "+rootDir,100);
            }else{
                Log.d(TAG, "Init root folder" + rootDir.getAbsolutePath());
                sendMyBroadcast(PROGRESS_ACTION,"create "+rootDir,100);
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
        Log.d(TAG,"root folder exists"+rootDir.getAbsolutePath());
        CopyFromAssets task = new CopyFromAssets();
        task.execute("helloWorld");
        return START_STICKY;
    }

    private class CopyFromAssets extends AsyncTask<String, Integer, Long>{

        @Override
        protected Long doInBackground(String... folderNames) {
            String folderName = folderNames[0];
            extractFolder(folderName);
            return null;
        }

        private void extractFolder(String folderName){
            try {
                String[] filesInside = assetManager.list(folderName);
                if(filesInside.length==0){
                    Log.d(TAG, "find file" + folderName);
                    extractFile(folderName);
                }else{
                    File fileDir = new File(rootDir,folderName);
                    if(!fileDir.exists()||!fileDir.isDirectory()){
                        fileDir.mkdir();
                        Log.d(TAG,"Make new folder "+folderName);
                    }else{
                        Log.d(TAG,"Folder exists "+folderName);
                    }
                    for(String eachFile:filesInside){
                        extractFolder(folderName + "/" + eachFile);
                    }
                }
            } catch (IOException e) {
                e.printStackTrace();
            }
        }

        private void extractFile(String fileName) {
            sendMyBroadcast(PROGRESS_ACTION, "Extracting: " + fileName, 0);
            Log.d(TAG, "Extracting " + fileName + "...");
            try {
                InputStream in = assetManager.open(fileName);
                int total = in.available();
                OutputStream out = new FileOutputStream(new File(rootDir,fileName));
                byte buffer[] = new byte[100000];
                int len = 0;
                while (true) {
                    int count = in.read(buffer);
                    if (count < 0)
                        break;
                    out.write(buffer, 0, count);
                    len += count;
                    int progress = (int) ((len * 1.0 / total) * 100);
                    Log.d(TAG,"extract:"+progress);
                    sendMyBroadcast(PROGRESS_ACTION, "Extracting: " + fileName, progress);
                    try {
                        Thread.sleep(100);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                in.close();
                out.close();
                Log.d(TAG, "Extracted " + len + " bytes to " + fileName);
            } catch (IOException e) {
                sendMyBroadcast(PROGRESS_ACTION, "can not Extracting: " + fileName, 100);
                Log.e(TAG, "Error to copy " + fileName + ":" + e);
            }
        }
    }

    private class MyBind extends Binder{
        public String[] readFile(){
            return null;
        }
        public boolean downloadFile(){
            return false;
        }
        public boolean importFile(){
            return false;
        }
        public boolean deleteFile(){
            return false;
        }
    }

    private void sendMyBroadcast(String action, String event, int progress) {
        if (!action.equals(EVENT_ACTION)) {
            broadcastIntent.setAction(action);
            broadcastIntent.putExtra("event", event);
            broadcastIntent.putExtra("progress", progress);
        } else {
            broadcastIntent.setAction(action);
        }
        sendBroadcast(broadcastIntent);
    }


}
